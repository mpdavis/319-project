{% extends 'base.html' %}

{% block title %}Round Robin{% endblock %}

{% block style %}
<style>
.match-wrapper{
    cursor: pointer;
}
.match-wrapper.not-started-message{
    cursor: auto;
}
div.match {
    display: inline-block;
    width: 150px;
    overflow-x: hidden;
    white-space: nowrap;
}
div.match.right{
    text-align: right;
}
div.match.right .rr-participant-score{
    padding: 0px 0px 0px 30px;
}
.rr-participant-name{
    margin-bottom: 0;
    display: inline;
    font-size: 14px;
    font-weight: bold;
}
.rr-participant-score{
    margin: 13px 0 3px 0;
    text-align: center;
    padding: 0px 30px 0px 0px;
    font-size: 22px;
    font-weight: bolder;
    color: #002ca0;
}
.rr-start-match{
    height: 25px;
    margin-top: 5px;
}
.not-started-message {
    font-style: italic;
    text-align: center;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header"><h1>{{ tournament.name }}</h1></div>
<div class="container-fluid">
    <div class="row-fluid">
    {% for round,matches in round_robin_rounds %}
        <div class="span4">
            <h3>Round {{ round }}</h3>
            <div class="well well-large">
            {% for match, participants in matches %}
                <div class="match-wrapper{% if match.status < 0 %} not-started{% endif %}" data-matchkey="{{ match.key() }}">
                {% for participant in participants %}
                    <div class="{{ loop.cycle('match', 'match right') }}">
                        <p class="rr-participant-name" id="{{ participant.key() }}-name">{{ participant.name }}</p>
                        {% if match.status > -1 %}
                            <p class="rr-participant-score" id="{{ participant.key() }}-score">{{ participant.score|replace('.0','') }}</p>
                        {% endif %}
                    </div>
                {% endfor %}
                {% if match.status < 0 %}
                    <div class="rr-start-match">
                        <button class="btn btn-mini btn-primary btn-block" id="{{ match.key() }}-start">Start this Match</button>
                        <p class="not-started-message">This match has not been started yet!</p>
                    </div>
                {% endif %}
            </div>
                {% if not loop.last %}
                <hr>
                {% endif %}
            {% endfor %}
            </div>
        </div>
        {{ loop.cycle('','','</div><div class="row-fluid">'|safe) }}
    {% endfor %}
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    $('.rr-start-match > .btn').css('display','none');
    $('.match-wrapper').mouseover(function(){
        $(this).find('.rr-start-match > .btn').css('display','inline');
        $(this).find('.rr-start-match > p.not-started-message').css('display','none');
    });
    $('.match-wrapper').mouseleave(function(){
        $(this).find('.rr-start-match > .btn').css('display','none');
        $(this).find('.rr-start-match > p.not-started-message').css('display','block');
    });
    $('.match-wrapper').click(function(){
       $('match-wrapper').popover('hide');
    });
    $('.match-wrapper:not(.not-started)').popover({
        html: true,
        placement: 'top',
        title: 'Update Match',
        content: get_popover_content
    })
    //Handler for start match button.
    $('.rr-start-match > .btn').click(function(){
        var url = '/tournament/update_match';
        var match_key = $(this).attr('id').substr(0, $(this).attr('id').length-6)
        $.getJSON(url,
                {'match': {'match_key': match_key, 'match_status': '0'}},
                function(data) {
                    $(data.p1_key + 'score').html(data.p1_score).css('background-color', '#00aaaa').animate({backgroundColor: "#FFFFFF"}, 1000);
                    $(data.p2_key + 'score').html(data.p2_score).css('background-color', '#0045bc').animate({backgroundColor: "#FFFFFF"}, 1000);
                });
    });
    //Handler for updating a score on a match.
    $('.update-score').blur(function(){
        var url = '/tournament/update_match';
        var match_key = $(this).attr('id').substr(0, $(this).attr('id').length-6);
        var p1_obj = $(this).find('.rr-participant-name').first();
        var p1_key = p1_obj.attr('id').substr(0,$(this).attr('id').length-5);
        var p1_score = $(p1_key + '-score').html();
        var p2_obj = $(this).find('.rr-participant-name').eq(1);
        var p2_key = p2_obj.attr('id').substr(0,$(this).attr('id').length-5);
        var p2_score = $(p2_key + '-score').html();
        $.getJSON(url,
                  {'match':{'match_key': match_key, 'match_status':'0', 'player1':{'key':p1_key, 'score':p1_score}, 'player2':{'key':p2_key, 'score':p2_score}}},
                  function(data){
                      $(data.p1_key + 'score').html(data.p1_score).css('background-color', '#00aaaa').animate({backgroundColor: "#FFFFFF"}, 1000);
                      $(data.p2_key + 'score').html(data.p2_score).css('background-color', '#0045bc').animate({backgroundColor: "#FFFFFF"}, 1000);
                  }
        );
    });

{#    $(this).parent('match-wrapper').popover('destroy');#}

});

function get_popover_content(){

    var form = '<form class="form-horizontal" method="post">';
    var controlGroup = '<div class="control-group">';
    var controls = '<div class="controls">';
    var endDiv = '</div>';
    var label1 = '<label class="control-label" style="font-weight:bold;">' + $(this).find('.rr-participant-name').html() + ':</label>';
    var input1 = '<input class="update-score span1" type="text" name="participant1_score" value="' + $(this).find('.rr-participant-score').first().html() + '" />';
    var label2 = '<label class="control-label" style="font-weight:bold;">' + $(this).find('.rr-participant-name').eq(1).html() + ':</label>';
    var input2 = '<input class="update-score span1" type="text" name="participant2_score" value="' + $(this).find('.rr-participant-score').eq(1).html() + '" />';
    var submit = '<input type="submit" class="btn btn-primary btn-mini" value="Update" />'
    var endForm = '</form>';
    return form + controlGroup + label1 + controls + input1 + endDiv + endDiv + controlGroup + label2 + controls + input2 + endDiv + endDiv + endForm;
}
</script>
{% endblock %}
